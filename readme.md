# OS
## 项目简介

这是一个从零开始实现的 **x86 架构、32 位保护模式下的简易操作系统内核**，主要参考《操作系统真相还原》一书完成，目标是通过“自己动手实现”的方式，深入理解操作系统的核心机制，而非追求功能完备或生产可用。

当前系统已完成从 **引导 → 内核初始化 → 中断管理 → 线程调度 → 用户进程切换** 的完整闭环，操作系统已经具备“多执行流 + 特权级隔离”的基本形态。

⚠️ 本项目 **仍在持续开发中**，文件系统、硬盘驱动与 Shell 尚未完成。

---

## 已实现功能

### 启动与运行环境

* 自制 MBR + Loader，引导内核进入保护模式
* 内核运行于 32 位保护模式（Ring0）
* 基于 Bochs 虚拟机运行与调试

### 中断与异常

* IDT 初始化
* 8259A 可编程中断控制器
* 时钟中断（系统节拍）
* 键盘中断
* 中断上下文保存与恢复

### 内存管理

* 物理内存位图管理
* 内核页表初始化
* 内核内存分配
* 用户虚拟地址池管理（为用户进程准备）

### 线程与调度

* 内核线程创建与管理
* 线程就绪队列
* 基于时间片的抢占式调度
* 上下文切换（switch.asm）

### 同步机制

* 自旋锁 / 互斥锁
* 信号量
* 临界区保护

### 终端与输入

* 控制台输出（console）
* 键盘驱动
* IO 队列（键盘缓冲区）

### 用户进程（已完成核心）

* TSS 初始化
* 用户态 / 内核态特权级切换（Ring3 ↔ Ring0）
* 用户进程启动（intr_exit + iret）
* 用户进程独立栈
* 用户进程参与调度

---

## 正在开发 / 未完成部分

* 硬盘驱动（IDE）
* 文件系统
* Shell（用户交互接口）
* 用户程序加载（ELF / 文件形式）

---

## 项目目录结构

```
OS/
├── boot/                # MBR 与 Loader
├── kernel/              # 内核核心代码（中断、内存、调度等）
├── device/              # 设备驱动（时钟、键盘、控制台）
├── thread/              # 线程、同步原语、上下文切换
├── userprog/            # 用户进程相关（TSS / process）
├── lib/                 # 内核基础库（string / bitmap / print）
├── include/             # 各模块头文件
│   ├── kernel/
│   ├── device/
│   ├── thread/
│   ├── userprog/
│   └── lib/
├── note/                # 学习与实现笔记
├── Makefile             # 构建脚本
└── build/               # 编译生成目录（不提交）
```

---

## 构建与运行环境

### 1. 推荐环境

* Linux（Ubuntu 20.04+ / Arch Linux）
* x86_64 主机

### 2. 使用 Docker（推荐）

避免宿主机 32 位工具链问题，可使用 Docker 构建环境：

* gcc (支持 -m32)
* nasm
* ld (elf_i386)
* make

> 项目在 Docker 容器内完成编译，Bochs 在宿主机运行。

### 3. 依赖工具

* gcc (支持 32 位编译)
* nasm
* binutils (ld)
* make
* bochs

---

## 编译方式

```bash
make        # 构建内核
make clean  # 清理 build 目录
```

生成文件：

```
build/kernel.bin
```

---

## 运行方式（Bochs）

1. 配置 bochsrc，将 kernel.bin 写入虚拟硬盘
2. 启动 Bochs
3. 内核启动后可看到：

   * 中断初始化信息
   * 键盘初始化完成
   * 用户进程切换相关输出

---

## 项目定位说明

* 本项目是 **学习型操作系统实现**
* 目标是理解：

  * CPU 特权级
  * 中断与调度
  * 进程与线程本质
* 并非：

  * Linux clone
  * 可用操作系统

---

## 当前状态

🚧 **开发中（Under Construction）**

已完成内核最核心的“进程与调度”部分，后续将继续实现：

* 文件系统
* Shell
* 完整用户程序支持

---

## 致谢

感谢《操作系统真相还原》一书提供的清晰路线，使得从“裸机”一步步走到“用户进程”成为可能。
