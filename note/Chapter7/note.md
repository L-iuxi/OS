# 中断
**`CPU 获知了计算机中发生的某些事，CPU 暂停正在执行的程序，转而去执行处理该事件的程序，
当这段程序执行完毕后，CPU 继续执行刚才的程序。整个过程称为中断处理，也称为中断。`**

### 并发和并行的区别:
**并发**指的是单位时间内的累积工作量，比如每秒并发数是 100，这是指一秒内累积的请求量总和为 100 个请求，属于并发
**并行**是指真正同时进行的工作量，比如并行100 个请求量是指任意瞬间都有 100 个请求在发生，所以**单核 CPU 谈并发，多核 CPU 谈并行**

### 中断的分类
#### 一.外部中断
**`外部中断是来自cpu外部的中断，而外部的中断源必须是某个硬件，所以外部中断又称为硬件中断`**
![alt text](image.png)
CPU 中有两条接收中断的信号线：INTR和 NMI。也就是说所有的外部设备的中断信息都走一根信号线。只要从 INTR 引脚收到的中断都是不影响系统运行的，可以随时处理，甚至 CPU 可以不处理，假装没看见，因为它不影响 CPU 运行。而只要从 NMI 引脚收到的中断，那基本上全是硬伤，CPU 都没有运行下去的必要了。

##### 可屏蔽中断
可屏蔽中断是通过 INTR 引脚进入 CPU 的，外部设备如硬盘、网卡等发出的中断都是可屏蔽中断。
可屏蔽的意思是此外部设备发出的中断，CPU 可以不理会，因为它不会让系统宕机，

##### 不可屏蔽中断
不可屏蔽中断是通过 NMI 引脚进入 CPU 的，它表示系统中发生了致命的错误，它等同于宣布：计算机的运行到此结束了。

#### 二.内部中断

##### 软中断
就是由软件主动发起的中断，因为它来自于软件，所以称之为软中断

### 中断描述符表
中断描述符表（Interrupt Descriptor Table，IDT）是保护模式下用于存储中断处理程序入口的表

#### 门描述符
##### 一.任务门
任务门和任务状态段（Task Status Segment，TSS）是 Intel 处理器在硬件一级提供的任务切换机制，所以任务门需要和 TSS 配合在一起使用，在任务门中记录的是 TSS 选择子，偏移量未使用。
##### 二.中断门
中断门包含了中断处理程序所在段的段选择子和段内偏移地址。当通过此方式进入中断后，标志寄存器 eflags 中的 IF 位自动置 0，也就是在进入中断后，自动把中断关闭，避免中断嵌套
##### 三.陷阱门
陷阱门和中断门非常相似，区别是由陷阱门进入中断后，标志寄存器 eflags 中的 IF 位不会自动置 0。陷阱门只允许存在于 IDT 中。
##### 四.调用门
调用门是提供给用户进程进入特权 0 级的方式，其 DPL 为 3。

**除调用门外，另外的任务门、中断门、陷阱门都可以存在于中断描述符表中。**

#### lidt
lidt 48 位内存数据
在这 48 位内存数据中，前 16 位是 IDT 表界限，后 32 位是 IDT 线性基地址。
![alt text](image-1.png)

### 中断的过程
#### CPU 外
**外部设备的中断由中断代理芯片接收，处理后将该中断的中断向量号发送到 CPU。**
#### CPU 内
**CPU 执行该中断向量号对应的中断处理程序。（以下步骤）**
1. 处理器根据中断向量号定位中断门描述符
2. 处理器进行特权级检查
    a.软中断，用户进程主动发起的中断，由用户代码控制。检查特权级和DPL，即检查下限
    b.检查特权级的上限（门框）：处理器要检查当前特权级 CPL 和门描述符中所记录的选择子对应的目标代码段 DPL
3. 执行中断处理程序




